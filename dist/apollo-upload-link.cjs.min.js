"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@apollo/client"),r=require("ts-invariant"),t=require("graphql/language/printer"),n=function(e,r){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(e,r)};var o=function(){return(o=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e}).apply(this,arguments)};var a=Object.prototype.hasOwnProperty;var i=function(e,t){var n;try{n=JSON.stringify(e)}catch(e){var o=new r.InvariantError("Network request failed. "+t+" is not serializable: "+e.message);throw o.parseError=e,o}return n};var s=require("extract-files"),c=s.extractFiles,l=s.isExtractableFile;function u(e,r,t){e.append(r,t,t.name)}var p=function(r){void 0===r&&(r={});var n=r.uri,s=void 0===n?"/graphql":n,p=r.fetch,f=r.includeExtensions,d=r.useGETForQueries,h=r.isExtractableFile,v=void 0===h?l:h,y=r.formDataAppendFile,b=void 0===y?u:y,m=function(e,r){var t={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&r.indexOf(n)<0&&(t[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)r.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(t[n[o]]=e[n[o]])}return t}(r,["uri","fetch","includeExtensions","useGETForQueries","isExtractableFile","formDataAppendFile"]);e.checkFetcher(p),p||(p=fetch);var O={http:{includeExtensions:f},options:m.fetchOptions,credentials:m.credentials,headers:m.headers};return new e.ApolloLink((function(r){var n=e.selectURI(r,s),l=r.getContext(),u={};if(l.clientAwareness){var f=l.clientAwareness,h=f.name,y=f.version;h&&(u["apollographql-client-name"]=h),y&&(u["apollographql-client-version"]=y)}var m,x=o(o({},u),l.headers),E={http:l.http,options:l.fetchOptions,credentials:l.credentials,headers:x},g=function(e,r){for(var n=[],a=2;a<arguments.length;a++)n[a-2]=arguments[a];var i=o(o({},r.options),{headers:r.headers,credentials:r.credentials}),s=r.http||{};n.forEach((function(e){i=o(o(o({},i),e.options),{headers:o(o({},i.headers),e.headers)}),e.credentials&&(i.credentials=e.credentials),s=o(o({},s),e.http)}));var c=e.operationName,l=e.extensions,u=e.variables,p=e.query,f={operationName:c,variables:u};return s.includeExtensions&&(f.extensions=l),s.includeQuery&&(f.query=t.print(p)),{options:i,body:f}}(r,e.fallbackHttpConfig,O,E),w=g.options,q=g.body,A=c(q,"",v),j=A.clone,N=A.files,P=i(j,"Payload");if(!w.signal){var F=function(){if("undefined"==typeof AbortController)return{controller:!1,signal:!1};var e=new AbortController;return{controller:e,signal:e.signal}}(),_=F.controller,S=F.signal;(m=_)&&(w.signal=S)}if(d&&!r.query.definitions.some((function(e){return"OperationDefinition"===e.kind&&"mutation"===e.operation}))&&(w.method="GET"),"GET"===w.method){var k=function(e,r){var t=[],n=function(e,r){t.push(e+"="+encodeURIComponent(r))};if("query"in r&&n("query",r.query),r.operationName&&n("operationName",r.operationName),r.variables){var o=void 0;try{o=i(r.variables,"Variables map")}catch(e){return{parseError:e}}n("variables",o)}if(r.extensions){var a=void 0;try{a=i(r.extensions,"Extensions map")}catch(e){return{parseError:e}}n("extensions",a)}var s="",c=e,l=e.indexOf("#");-1!==l&&(s=e.substr(l),c=e.substr(0,l));var u=-1===c.indexOf("?")?"?":"&";return{newURI:c+u+t.join("&")+s}}(n,q),C=k.newURI,I=k.parseError;if(I)return e.fromError(I);n=C}else if(N.size){delete w.headers["content-type"];var R=new FormData;R.append("operations",P);var T={},U=0;N.forEach((function(e){T[++U]=e})),R.append("map",JSON.stringify(T)),U=0,N.forEach((function(e,r){b(R,++U,r)})),w.body=R}else try{w.body=i(q,"Payload")}catch(I){return e.fromError(I)}return new e.Observable((function(t){var o;return p(n,w).then((function(e){return r.setContext({response:e}),e})).then((o=r,function(r){return r.text().then((function(e){try{return JSON.parse(e)}catch(n){var t=n;throw t.name="ServerParseError",t.response=r,t.statusCode=r.status,t.bodyText=e,t}})).then((function(t){return r.status>=300&&e.throwServerError(r,t,"Response not successful: Received status code "+r.status),Array.isArray(t)||a.call(t,"data")||a.call(t,"errors")||e.throwServerError(r,t,"Server response was missing for query '"+(Array.isArray(o)?o.map((function(e){return e.operationName})):o.operationName)+"'."),t}))})).then((function(e){return t.next(e),t.complete(),e})).catch((function(e){"AbortError"!==e.name&&(e.result&&e.result.errors&&e.result.data&&t.next(e.result),t.error(e))})),function(){m&&m.abort()}}))}))},f=function(e){function r(r){void 0===r&&(r={});var t=e.call(this,p(r).request)||this;return t.options=r,t}return function(e,r){function t(){this.constructor=e}n(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}(r,e),r}(e.ApolloLink);exports.UploadLink=f;
